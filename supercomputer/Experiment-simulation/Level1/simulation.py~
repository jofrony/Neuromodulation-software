import snudda
from snudda.neuromodulation.neuromodulation import SnuddaSimulateNeuromodulation
#from mpi4py import MPI  # This must be imported before neuron, to run parallel
#from neuron import h  # , gui
import timeit
import os
import sys
import pathlib

if '-python' in sys.argv:
        print("Network_simulate.py called through nrniv, fixing arguments")
        pythonidx = sys.argv.index('-python')
        if len(sys.argv) > pythonidx:
            sys.argv = sys.argv[pythonidx + 1:]



network_path =  sys.argv[1]
neuromodulation = sys.argv[2]
t_sim = int(sys.argv[3])
name = sys.argv[4]


network_file = os.path.join(network_path, "network-synapses.hdf5")
input_file = os.path.join(network_path, "input-spikes.hdf5")
path = pathlib.Path(os.path.join(network_path, "simulation"))
path.mkdir(parents=True, exist_ok=True)
save_dir = os.path.join(os.path.dirname(network_file), "simulation")
volt_file = os.path.join(save_dir, f"network-voltage-{name}.csv")
spikes_file = os.path.join(save_dir, f"network-output-spikes-{name}.txt")
log_file = os.path.join(os.path.dirname(network_file), "log", "network-simulation-log.txt")
disable_gj = False





start = timeit.default_timer()
#pc = h.ParallelContext()
sim = SnuddaSimulateNeuromodulation(network_file=network_file,
                            input_file=input_file,
                            disable_gap_junctions=disable_gj,
                            log_file=log_file)

sim.load_network_info(network_file)
sim.check_memory_status()
sim.distribute_neurons()
sim.setup_neurons()
sim.check_memory_status()
sim.pc.barrier()

sim.connect_network()
sim.check_memory_status()
sim.pc.barrier()

sim.add_external_input()

sim.apply_neuromodulation(neuromodulation)
sim.neuromodulation_network_wide()

sim.check_memory_status()

sim.add_recording(side_len=None) 
sim.check_memory_status()
sim.run(t_sim) 
sim.write_spikes(spikes_file)
sim.write_voltage(volt_file)
stop = timeit.default_timer()

if sim.pc.id() == 0:
    print("Program run time: " + str(stop - start))
